# 云端数据同步说明

## 问题现象

您遇到的问题包括：
1. 在本地（localhost:3000）可以看到完整的上下游关系和图谱，但在Vercel部署的网站（https://jsh.hhaix.tech）上看不到
2. 在本地部署的网站左侧导航栏"再次编辑自己的卡片信息"下方可以看到卡片名字列表，但在Vercel上看不到

## 原因分析

### 问题1：上下游关系数据不同步

这是因为**本地数据和云端数据是分开存储的**：

1. **本地开发环境**：
   - 数据存储在浏览器的 `localStorage` 中
   - 所有修改都立即生效
   - 不需要配置Supabase

2. **Vercel生产环境**：
   - 数据存储在 Supabase 云端数据库中
   - 需要正确配置 Supabase 环境变量
   - 所有用户共享同一个云端数据库

## 解决方案

### 方案1：确保Supabase配置正确

1. 登录到您的 Vercel 项目
2. 进入 Settings -> Environment Variables
3. 确保以下环境变量已配置：
   ```
   NEXT_PUBLIC_SUPABASE_URL=你的Supabase项目URL
   NEXT_PUBLIC_SUPABASE_ANON_KEY=你的Supabase匿名密钥
   ```

4. 如果没有配置，请按照以下步骤：
   - 登录 https://supabase.com
   - 进入您的项目
   - 点击 Settings -> API
   - 复制 Project URL 和 anon/public key
   - 在 Vercel 中添加这两个环境变量
   - 重新部署项目

### 方案2：从本地同步数据到云端

如果您已经在本地录入了大量数据，需要将其同步到云端：

1. **在本地开发环境中**：
   - 确保您的 `.env.local` 文件包含正确的 Supabase 配置
   - 重启开发服务器 (`npm run dev`)
   - 数据会自动开始同步到云端

2. **手动同步数据**：
   - 打开本地开发环境的浏览器控制台（F12）
   - 执行以下代码检查数据：
   ```javascript
   // 查看本地人物数据
   console.log('本地人物数据:', JSON.parse(localStorage.getItem('ecosystem_people')))
   
   // 查看本地企业数据
   console.log('本地企业数据:', JSON.parse(localStorage.getItem('ecosystem_companies')))
   ```

3. **验证云端同步**：
   - 登录 Supabase 控制台
   - 进入 Table Editor
   - 查看 `people` 和 `companies` 表
   - 确认数据已经同步

### 方案3：重新在生产环境录入数据

如果上述方案不可行，您可以：
1. 直接在 https://jsh.hhaix.tech 上重新录入数据
2. 所有数据会直接保存到云端
3. 所有用户都能看到同步后的数据

## 数据同步机制说明

系统的数据同步机制如下：

1. **添加新人物/企业**：
   - 先保存到本地 localStorage
   - 同时异步上传到 Supabase 云端
   - 如果云端上传失败，会在控制台显示警告

2. **编辑人物/企业**：
   - PersonEditModal 会调用 `/api/update-person` API
   - API 同时更新本地和云端数据
   - 如果云端更新失败，会显示警告但本地数据仍然更新

3. **查看数据**：
   - 开发环境：优先使用云端数据，如果云端不可用则使用本地数据
   - 生产环境：仅使用云端数据

## 检查清单

请按照以下清单排查问题：

- [ ] Vercel 环境变量已配置
- [ ] Supabase 项目正常运行
- [ ] Supabase 表结构正确（参考 `supabase-setup.sql` 和 `supabase-update-schema.sql`）
- [ ] 本地 `.env.local` 文件已配置（用于开发环境同步）
- [ ] 数据已成功上传到 Supabase（在 Supabase Table Editor 中检查）

## 关于上下游关系数据

特别注意，企业的上下游关系数据存储在：
- `companies.suppliers` - 上游供应商列表
- `companies.customers` - 下游客户列表
- `companies.supplier_infos` - 供应商详细信息（包含采购类别等）
- `companies.customer_infos` - 客户详细信息（包含采购类别等）

确保这些字段在 Supabase 中正确创建和映射。

### 问题2："我的卡片"名字列表不显示

**原因**：
- "我的卡片"标记存储在浏览器的 `localStorage` 中
- 本地开发环境和Vercel生产环境使用不同的localStorage
- 这是设计上的限制，因为localStorage是浏览器本地存储，不会自动同步

**解决方案**：
1. **当前解决方法**：
   - 在Vercel网站上，您仍然可以看到所有人物数据
   - 只是左侧导航栏的"我的卡片"快捷列表不显示
   - 您可以通过搜索或浏览主列表找到需要编辑的人物卡片

2. **未来改进（可选）**：
   - 可以在Supabase中添加一个字段标记"我的卡片"
   - 或者在人物数据中添加"创建者"字段

**注意**：这个问题不影响数据的完整性，所有人物和企业数据都会正确同步到云端。只是一个快捷访问功能在跨设备使用时不可用。

## 需要帮助？

如果您仍然遇到问题，请提供以下信息：
1. Vercel 部署日志
2. 浏览器控制台错误信息（F12打开开发者工具）
3. Supabase 项目配置截图
4. 本地和生产环境的具体差异描述

## 快速验证清单

请按以下步骤验证系统是否正常工作：

1. **验证云端连接**：
   - 打开 https://jsh.hhaix.tech/dashboard
   - 按F12打开浏览器控制台
   - 查看是否有Supabase相关错误

2. **验证数据同步**：
   - 在Vercel网站上添加一个测试人物
   - 登录Supabase控制台查看people表
   - 确认数据已保存

3. **验证上下游数据**：
   - 编辑一个企业，添加上下游信息
   - 保存后刷新页面
   - 查看企业详情页面是否显示供应链图谱

